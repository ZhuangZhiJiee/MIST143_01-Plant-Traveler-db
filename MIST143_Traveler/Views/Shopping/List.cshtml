@model MIST143_Traveler.MViewModel.CProductViewModel
@using Microsoft.AspNetCore.Http
@using System.Text.Json;
@inject IHttpContextAccessor Accessor




@{
    ViewData["Title"] = "List";

}

@section Styles{

    <link href="~/css/924自用.css" rel="stylesheet" />
    <link href="~/css/style.css" rel="stylesheet" />
    @*<link href="~/css/bootstrap.min.css" rel="stylesheet" />*@
    <link href="~/css/product.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/travelOrder.css" />
}



<body class="p-0 m-0 border-0 bd-example">
    <div class="p-0 m-0 border-0 mx-auto 最大的">
        <div class="col-10">
            <div class="activity-page-container">
                <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="true">
                    <div class="carousel-indicators">
                        @for (int i = 0; i < Model.productpictures.Count; i++)
                        {
                        <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="@i" class="carouselExampleIndicators"  aria-current="true" aria-label="幻燈片 1"></button>
                        }
                        
                      
                    </div>

                    <div class="carousel-inner 照片的包皮">
                        @foreach (var item in Model.productpictures)
                        {
                            <div class="carousel-item">
                                <img src="https://localhost:44338/images/TravelProductPictures/@item.TravelPicture1" class="d-block carouselImg" alt="...">
                            </div>
                        }

                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前的</font></font></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一個</font></font></span>
                    </button>
                </div>

            </div>
        </div>
        
        <div class="分類">
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">首頁</a></li>
                    <li class="breadcrumb-item active" aria-current="page">101</li>
                </ol>
            </nav>
        </div>

        <div class="標題">
            <h3 id="productName">@Model.TravelProductName</h3>
        </div>
        <div class="小介紹">
            <div class="評價">
                <img src="~/Images/Product/一顆星.png" /><span>5.0</span>(3則評價) 3人參加過
                @{
                    if (Accessor.HttpContext.Session.Keys.Contains(CDictionary.SK_Login))
                    {
                        var OBJ = Accessor.HttpContext.Session.GetString(CDictionary.SK_Login);//取得登入者的SESSION
                        var v = JsonSerializer.Deserialize<Member>(OBJ);
                        <div class="我的最愛">
                            @*<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                            </svg>*@
                            <div>
                                <input type="hidden" id="PID" name="TravelProductId" value="@Model.TravelProductId" />
                                <input type="hidden" id="MID" name="MembersId" value="@v.MembersId" />
                                <label class="btn">
                                    <i class="bi bi-heart" onclick=toMyFavorites()>加入我的最愛</i>
                                </label>
                                @*@Html.ActionLink("加入我的最愛", null, null, null, null)*@
                            </div>
                        </div>
                    }

                }
            </div>
        </div>
        <br />
        <div class="小介紹" id="prodctDescriptionHidden">@Model.Description</div>
        <div class="小介紹" id="prodctDescription"></div>
     
            <article class="payContainer choose">
                <div class="payContainerInner">
                    <div>
                        <div class="row">
                            <div class="col-8">
                                <div class="infoTitle hasTag">方案選擇</div>
                                <div class="leftSide grey py-3">
                                    <div class="chooseTitleRow">
                                        <div class="infoTitle mt-4">選擇日期及方案組合</div>
                                        <button type="button" class="btn btn-outline-primary mx-3">清除全部</button>
                                    </div>
                                    @*<div class="subInfoText ps-3">請選擇參加日期</div>*@
                                    @*<div class="selectInput ps-3">
            <input type="date" id="start" name="trip-start" class="form-control" value="2022-10-11"
                   min="2022-10-11" max="2022-12-31">
        </div>*@
                                    <div class="subInfoText ps-3">方案類型</div>
                                    <div class="payUserRow ps-3">
                                        <div class="payUser active">
                                            @Model.TravelProductName
                                        </div>
                                    </div>
                                    <div class="subInfoText ps-3">時間</div>
                                    <div class="selectInput ps-3">
                                        @foreach (var item in Model.Date)
                                        {
                                            @item<br />
                                        }
                                    </div>
                                    <br />
                                    <div class="subInfoText ps-3">景點</div>
                                    <div class="selectInput ps-3">
                                        @foreach (var item in Model._CProductDetailViewModel)
                                        {
                                            @foreach (var item2 in item.ViewName)
                                            {
                                                @item2<br />
                                            }
                                        }
                                    </div>
                                    <br />
                                    <div class="subInfoText ps-3">住宿飯店</div>
                                    <div class="selectInput ps-3">
                                        @foreach (var item in Model.HotelName)
                                        {
                                            @if (@item != null)
                                            {@item<br />}

                                        }
                                    </div>
                                    <br />
                                    <form method="post" action="PayData">
                                        <div class="subInfoText ps-3">數量</div>
                                        <div class="py-3">
                                            <div class="chooseNumberRow mx-3">
                                                <div class="chooseTitle">
                                                    每人
                                                </div>
                                                <div class="chooseNumberBlock">
                                                    <button type="button" id="productMinus"
                                                            class="btn btn-outline-secondary">
                                                        -
                                                    </button>
                                                    <div class="number">
                                                        <input type="number" class="productNumber" id="productNum" name="Count" value="1" />
                                                    </div>
                                                    <button type="button" id="productPlus"
                                                            class="btn btn-outline-secondary">
                                                        +
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="px-3 totalRow">
                                            <div class="my-3">
                                                <div class="titleFontStyle">NT$ <span id="totalPrice"></span></div>
                                                <div class="subInfoText">完成所有必填選項</div>
                                                <div class="subInfoText">剩餘:  @Model.Stocks 個位置</div>
                                            </div>
                                            <div class="rightBtns">

                                                <input type="hidden" name="TravelProductId" value="@Model.TravelProductId" />
                                                <input type="submit" value="  立即預定  " class="btn btn-main ms-3" />
                                            </div>
                                        </div>
                                    </form>
                                    <form method="post" action="AddToSession" class="addshoppingCart">
                                        <input type="hidden" name="TravelProductId" value="@Model.TravelProductId" />
                                        <input type="hidden" name="TravelProductName" value="@Model.TravelProductName" />
                                        <input type="hidden" name="Count" value="1" id="postProductNum" />
                                        <input type="hidden" name="Price" value="@Model.Price" />
                                        <input type="hidden" name="Productpicture" value="@Model.productpictures.FirstOrDefault().TravelPicture1" />
                                        <input type="submit" value="加入購物車" data-bs-toggle="modal" data-bs-target="#joinModal" class="btn btn-main mx-3" />
                                    </form>

                                </div>
                            </div>
                            <div class="col-4">
                                <div class="leftSide grey p-3">
                                    <div class="titleFontStyle">行程明細</div>
                                    <div class="hiddenInfoNote hiddenEle">
                                    <br />

                                        @foreach (var item in Model.DailyDetailText)
                                        {
                                            <div class="mb-3">
                                                @item
                                            </div>
                                        }
                                    </div>
                                    <div id="productInfoNote"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
      
            <div class="下面一包">
                <div class="活動DIV">
                    <h2><span class="一條根"> </span><span>活動介紹</span></h2>
                </div>
                <div class="小介紹">
                    @Model.EventIntroduction
                </div>
                @foreach (var item in Model.productpictures)
                {
                    <img src="https://localhost:44338/images/TravelProductPictures/@item.TravelPicture1" class="下圖" />
                    <figcaption class="下圖小字">@item.TravelPictureText</figcaption>
                }

                <div class="活動DIV">
                    <h2><span class="一條根"> </span><span>地點</span></h2>
                </div>
                <iframe src="@Model.MapUrl" width="850" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                <div class="活動DIV">
                    <h2><span class="一條根"> </span><span>行前準備</span></h2>
                </div>
                <div class="小介紹 hiddenPreparationDescription hiddenEle">
                    @Model.PreparationDescription
                </div>
                <div class="小介紹 preparationDescription"></div>
                <div class="活動DIV">
                    <h2><span class="一條根"> </span><span>活動評價</span></h2>
                    <div class="評論">
                        <div class="card mb-3" style="max-width: 850px;">
                            <div class="row g-0">

                                <div class="col-md-1">
                                    <img src="~/Images/Product/_.jpg" class="img-fluid rounded-start" alt="...">
                                </div>

                                <div class="col-md-10">
                                    <div class="card-body">
                                        <h5 class="card-title">恆佑</h5>
                                        <img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" />
                                        <p class="card-text">視野極佳很好拍照，風景可讓人放鬆，是不錯的選擇，室內環境很乾淨，可在加購101層票券，第一次體驗88～89樓和101樓層拍照，個人覺得很美很舒適。</p>
                                        <p class="card-text"><small class="text-muted">2022/5/35</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3" style="max-width: 850px;">
                            <div class="row g-0">

                                <div class="col-md-1">
                                    <img src="~/Images/Product/_.jpg" class="img-fluid rounded-start" alt="...">
                                </div>

                                <div class="col-md-10">
                                    <div class="card-body">
                                        <h5 class="card-title">恆佑</h5>
                                        <img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" />
                                        <p class="card-text">視野極佳很好拍照，風景可讓人放鬆，是不錯的選擇，室內環境很乾淨，可在加購101層票券，第一次體驗88～89樓和101樓層拍照，個人覺得很美很舒適。</p>
                                        <p class="card-text"><small class="text-muted">2022/5/35</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3" style="max-width: 850px;">
                            <div class="row g-0">

                                <div class="col-md-1">
                                    <img src="~/Images/Product/_.jpg" class="img-fluid rounded-start" alt="...">
                                </div>

                                <div class="col-md-10">
                                    <div class="card-body">
                                        <h5 class="card-title">恆佑</h5>
                                        <img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" /><img src="~/Images/Product/一顆星.png" />
                                        <p class="card-text">視野極佳很好拍照，風景可讓人放鬆，是不錯的選擇，室內環境很乾淨，可在加購101層票券，第一次體驗88～89樓和101樓層拍照，個人覺得很美很舒適。</p>
                                        <p class="card-text"><small class="text-muted">2022/5/35</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
    </div>
    <!-- 已加入購物車訊息彈窗 -->
    <div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
         style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <button type="button" class="btn-close modalClose " data-bs-dismiss="modal"
                        aria-label="Close"></button>
                <div class="infoTitle mt-4"></div>
                <div class="modal-body text-center ">
                    <h4>已加入至購物車</h4>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                            aria-label="Close">
                        確定
                    </button>
                </div>
            </div>
        </div>
    </div>
    @section Scripts{

        <script src="~/js/travelOrder.js"></script>
        <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            window.onload = function () {
                //頁面載入時初始總價
                $('#totalPrice').text( @Model.Price)
                //調整描述 換行 加圓點
                let descritpionContent = $('#prodctDescriptionHidden').text()
                let descritpionContentLength = descritpionContent.length
                if (descritpionContent[descritpionContentLength - 1] === '#') {
                    descritpionContent = descritpionContent.slice(0, descritpionContentLength - 1)
                } else if (descritpionContent.slice(descritpionContentLength - 3, descritpionContentLength - 0) === '#\r\n') {
                    descritpionContent = descritpionContent.slice(0, descritpionContentLength - 3)
                }
                descritpionContent = descritpionContent.replace(/#/g,"<br> ● ")
                $('#prodctDescription').html(descritpionContent)
                //換行 加圓點
                let preparationDescription = $('.hiddenPreparationDescription').text()
                if (preparationDescription[preparationDescription.length - 1] === '#') {
                    preparationDescription = preparationDescription.slice(0, preparationDescription.length - 1)
                } else if (preparationDescription.slice(preparationDescription.length - 3, preparationDescription.length - 0) === '#\r\n') {
                    preparationDescription = preparationDescription.slice(0, preparationDescription.length - 3)
                }
                preparationDescription = preparationDescription.replace(/#/g, "<br> ● ")
                $('.preparationDescription').html(preparationDescription)

                let descritpionLabel = $(".hiddenInfoNote").html()
                descritpionLabel = descritpionLabel.replace(/#/g, "<br>")
                $('#productInfoNote').html(descritpionLabel)
                $('.carousel-item')[0].classList.add("active")
                $('.carouselExampleIndicators')[0].classList.add("active")
                
            }
            //點擊加號
            $('#productPlus').click(function () {
                let currentNum = parseInt($('#productNum').val())
                currentNum += 1
                $('#productNum').val(currentNum)
                $("#postProductNum").val($('#productNum').val())
                $('#totalPrice').text(currentNum * @Model.Price)
            });
            //點擊減號
            $('#productMinus').click(function () {
                let currentNum = parseInt($('#productNum').val())
                if (currentNum > 1) {
                    currentNum -= 1
                    $('#productNum').val(currentNum)
                }
                $('#totalPrice').text(currentNum * @Model.Price)
                $("#postProductNum").val($('#productNum').val())
            });
            //改變數量
            $('#productNum').change(function () {
                let currentNum = $('#productNum').val()
                $("#postProductNum").val(currentNum)
                $('#totalPrice').text(currentNum * @Model.Price)
            })

            //=============================存入我的最愛================================

            const toMyFavorites = () =>
            {
                //function love(i) {
                //    var c = $("#heart" + i).attr('class')
                //    if (c == 'bi bi-heart') {
                //        $("#heart" + i).toggleClass("bi bi-heart-fill")
                //    }
                //    else
                //        $("#heart" + i).toggleClass("bi bi-heart")
                //}

                var Tofa = {
                    TravelProductId:$("#PID").val(),
                    MembersId:$("#MID").val(),
                }
                console.log(Tofa)
                $.ajax({
                    url: '@Url.Action("toMyFavorites", "CustomerCenter")',
                    method: 'Post',
                    dataType: 'Json',
                    data: { PMID: Tofa },
                    success: function (datas) {
                        if (!datas.res) {
                            Swal.fire('已經在我的最愛囉!')
                            return;
                        }
                        Swal.fire(
                            'Good job!',
                            '加入我的最愛囉!',
                            'success'
                        )
                    }
                })
            }

        </script>
    }
</body>

